{"pageProps":{"title":"Deno Tests & GitHub Actions CI","slug":"deno-and-github-actions","date":"May 23, 2020","excerpt":"As part of translating my JavaScript and Node Battlesnake to TypeScript and Deno I wanted to setup continuous integration. It was som much easier than I imagined using GitHub Actions.","hero":"/images/posts/DenoTestsAndGithubActionsCI.png","tags":["javascript","typescript","node","deno","github-actions","ci/cdgs"],"content":"# Deno Tests and GitHub Actions CI\n#### May 23, 2020\n\nDuring a recent project to convert my JavaScript & Node [Battlesnake](https://play.battlesnake.com/) over to TypeScript & [Deno](https://deno.land/), I decided I would also create a more robust suite of tests for it.\n\n![Deno and Github logos with an addition symbol between them](DenoTestsAndGithubActionsCI.png)\n\nIf you are unfamiliar with [Battlesnake](https://play.battlesnake.com/), it is an online and in-person programming competition where you build a AI in the form of a REST API that can play a multiplayer version of the classic game [Snake](https://en.wikipedia.org/wiki/Snake_(video_game_genre). You can check out details on their [website](https://play.battlesnake.com/) to learn more, and even watch some past events on their [Twitch channel](https://www.twitch.tv/BattlesnakeOfficial).\n\n## Tl;dr\n* [Deno Tests](#deno-tests): Deno includes a very simple test runner framework.\n* [Github Actions](#github-actions): Github actions allow you to automate tasks based on triggers within your Github repo.\n* [Create the workflow](#create-the-workflow): A .yml file describes a series of actions you would like to perform based on a trigger.\n* [Automate Deno tests](#automate-deno-tests): Just add a `run: deno test` command to your workflow .yml.\n\n## Deno Tests\n[Deno](https://deno.land/) includes a simple test runner for tests in js, ts, jsx, or tsx files. It can be run with:\n\n```bash\ndeno test\n```\n\nTo create tests, all you need to use is use the `Deno.test()` method included with Deno within files ending in *test* (`{*_,}test.{js,ts,jsx,tsx}`) anywhere in your project structure. I put mine in *tests/*.\n\nExample of a basic test:\n\n```typescript\nimport { assert } from \"https://deno.land/std/testing/asserts.ts\";\nimport { root } from \"../app/main.ts\";\n\nDeno.test(\"Root response contains expected fields\", () => {\n  // when\n  const result = root();\n  // then\n  assert(result?.apiversion);\n  assert(result?.author);\n  assert(result?.head);\n  assert(result?.tail);\n  assert(result?.color);\n});\n```\n\nThis test is simply asserting that values exist for these specified fields.\n\nYou can add many tests to single files by calling `Deno.test()` over and over again. You can also make as many test files as you like, Deno will automatically execute all the files it recognizes ending in *test* (`{*_,}test.{js,ts,jsx,tsx}`).\n\nVisit the [Deno Testing docs](https://deno.land/manual/testing) for more info about creating tests.\n\nEasy! So now I can create a robust set of unit tests for my Battlesnake AI.\n\nSince the game Battlesnake works by [sending you the entire game state for every move](https://docs.battlesnake.com/references/api), I can also save the game state JSON from particularly tricky moves and use them within their own tests. The output can be compared against the single best move, or even a set of equally good moves if their are multiple. Creating tests like this tests the behaviour of the AI overall and ensures that changes to the behaviour aren't making the AI perform worse on moves it previously was able to do correctly.\n\nSo now that I have tests up and working, I wanted to automate them using Github Actions.\n\n## Github Actions\nGithub Actions are still quite new to me and I hadn't touched them at all before this project. I just assumed it would be complicated to set up.\n\nFor what I wanted to do for this project it was actually trivial. Couldn't have been easier.\n\nWhat I wanted was to run these tests automatically whenever pushing to my repository. I figured this Deno app is pretty simple all things considered, so I shouldn't have to mess around with Docker or anything like that.\n\nI'll step you through what I did.\n\n## Create the workflow\nGithub Actions are based around these things called workflows. They are essentially .yml scripts that describe the series of events you want to perform in your action.\n\nIf you click the Actions tab within the repo you want to create the Action you will be presented with a Get started with GitHub Actions page. This page has many example actions you get you started for so many different languages, frameworks, and platforms. It will even suggest actions to you based on the contents of your repo. I chose the *Skip this asn set up a workflow yourself* option.\n\n![Get started with Github Actions](DenoAndGithubActions-get-started-with-github-actions.png)\n\nThis plops you into a web editor and gives you a basic example workflow .yml file to start with. It looks something like this:\n\n```yaml\n# This is a basic workflow to help you get started with Actions\n\nname: CI\n\n# Controls when the action will run. Triggers the workflow on push or pull request\n# events but only for the master branch\non:\n  push:\n    branches: [ master ]\n  pull_request:\n    branches: [ master ]\n\n# A workflow run is made up of one or more jobs that can run sequentially or in parallel\njobs:\n  # This workflow contains a single job called \"build\"\n  build:\n    # The type of runner that the job will run on\n    runs-on: ubuntu-latest\n\n    # Steps represent a sequence of tasks that will be executed as part of the job\n    steps:\n    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it\n    - uses: actions/checkout@v2\n\n    # Runs a single command using the runners shell\n    - name: Run a one-line script\n      run: echo Hello, world!\n\n    # Runs a set of commands using the runners shell\n    - name: Run a multi-line script\n      run: |\n        echo Add other actions to build,\n        echo test, and deploy your project.\n\n```\n\nWith this you can actually click the *Start commit* button and that will guide you to commit this .yml file to your repo within the *.github/workflows/* directory.\n\nYou can see near the top of that file that there are triggers for `on push` and `on pull_request` attached to the master branch. You can try to push something to master and see it work!\n\nIf you visit the Actions tab of your repo now you will see your Actions and the history of all the times they have run. You can click into them for more details and to see the console outputs. Also by default it will email your Github account email whenever an action fails. I imagine this can be changed somewhere if you don't like that.\n\n![Github Actions](DenoAndGithubActions-github-actions.png)\n\n## Automate Deno tests\nNow I wanted to try to run my tests using Deno. I knew this would involve installing Deno somehow so I searched around.\n\nI found [this repo](https://github.com/denolib/setup-deno) from [denolib](https://github.com/denolib) with exactly what I wanted.\n\nReally all you need to do is add the `uses` line pointing to this repo to your workflow .yml file under the `steps` section. You can also include the Deno version you prefer. Then within the `run` section you now have access to `deno` and all of its functions.\n\nSo now my workflow .yml file looks like this:\n\n```yaml\nname: CI\n\non:\n  push:\n    branches: [ master ]\n  pull_request:\n    branches: [ master ]\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n\n    steps:\n    - uses: actions/checkout@master\n    - uses: denolib/setup-deno@master\n      with:\n        deno-version: v1.x\n    - run: deno run https://deno.land/std/examples/welcome.ts\n```\n\nOne really cool feature of Deno is that you can run scripts from the web right in the terminal, and you can also do this right within Github Actions. That is what the URL is doing in\n\n```yaml\n- run: deno run https://deno.land/std/examples/welcome.ts\n```\n\nYou can run this and then look within your Github Actions for the console output from this example *welcome.ts* file.\n\nSo now to run my tests, all I needed to do was change that `deno run` command to `deno test`. My final .yml workflow looks something like this:\n\n```yaml\nname: CI\n\non:\n  push:\n    branches: [ master ]\n  pull_request:\n    branches: [ master ]\n\njobs:\n  run-tests:\n    runs-on: ubuntu-latest\n\n    steps:\n    - uses: actions/checkout@master\n    - uses: denolib/setup-deno@master\n      with:\n        deno-version: v1.x\n    - run: deno test\n```\n\nNow every time I push to my master branch all my tests will be run, including any new tests I just committed, and I will be notified both on the Github UI and in my email if any tests fail. I can then log into Github and look at the output to see what failed.\n\nI hope this small guide helped you out and showed you just how simple both Deno and Github Actions are!"},"__N_SSG":true}